services:
  # Backend API service
  api-backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    environment:
      - SERVICE_NAME=api
      - PORT=8080
    ports:
      - "8080:8080"
    networks:
      - tailnet-demo

  # Backend Web service  
  web-backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    environment:
      - SERVICE_NAME=web
      - PORT=8081
    ports:
      - "8081:8081"
    networks:
      - tailnet-demo

  # tailnet proxy
  tailnet:
    image: ghcr.io/sudosu404/tailnet-cli:latest
    volumes:
      - ./tailnet.toml:/config/tailnet.toml:ro
      - tailnet-state:/var/lib/tailnet
    environment:
      # Replace with your actual OAuth credentials
      # You can get these from: https://login.tailscale.com/admin/settings/oauth
      - TS_OAUTH_CLIENT_ID=${TS_OAUTH_CLIENT_ID}
      - TS_OAUTH_CLIENT_SECRET=${TS_OAUTH_CLIENT_SECRET}
    command: ["-config", "/config/tailnet.toml", "-verbose"]
    depends_on:
      - api-backend
      - web-backend
    networks:
      - tailnet-demo
    ports:
      - "9090:9090"  # Metrics port

volumes:
  tailnet-state:

networks:
  tailnet-demo: